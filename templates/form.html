<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Employee Competency Form</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="py-4">
  <div class="container">
  <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mt-3">
          {% for category, msg in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ msg|safe }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    <!-- Header / Action Bar -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h3 class="mb-0"><i class="bi bi-person-lines-fill"></i> Employee Competency Form</h3>

      <div class="d-flex flex-wrap gap-2">
        <a href="/download-template" class="btn btn-success btn-sm">
          <i class="bi bi-file-earmark-excel"></i> Download Template
        </a>

        <!-- Upload Excel -->
        <form action="/upload" method="POST" enctype="multipart/form-data" style="display:inline;">
          <label class="btn btn-primary btn-sm mb-0">
            <i class="bi bi-upload"></i> Upload Excel
            <input type="file" name="file" accept=".xlsx" hidden onchange="this.form.submit()">
          </label>
        </form>

        <a href="/employees" onclick="saveFormData()" class="btn btn-secondary btn-sm">
          <i class="bi bi-people"></i> View Employee List
        </a>
      </div>
    </div>

    <!-- Form -->
    <div class="card p-4 shadow-sm">
      <form action="/submit" method="post" id="employeeForm" onsubmit="return validateForm();">

        <h5 class="section-header mb-3">Basic Information</h5>
        <div class="row mb-3">
          <div class="col-md-2">
            <label class="form-label">Year</label>
            <input type="text" name="year" class="form-control" required
                   value="{{ form_data.year if form_data else '' }}">
          </div>
          <div class="col-md-2">
            <label class="form-label">Code</label>
            <input type="text" name="code" class="form-control" required
                   value="{{ form_data.code if form_data else '' }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Full Name</label>
            <input type="text" name="full_name" class="form-control" required
                   value="{{ form_data.full_name if form_data else '' }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Title</label>
            <select name="title" class="form-select" id="titleSelect" required>
              <option value="">-- Select Title --</option>
              {% for t in ["Officer","Senior","Supervisor","Deputy Manager","Manager","Deputy Director","Director"] %}
                <option value="{{t}}" {% if form_data and form_data.title == t %}selected{% endif %}>{{t}}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Division</label>
            <select name="division" class="form-select" required>
              <option value="">-- Select Division --</option>
              {% for d in [
                "Office Assistant Division","Company Secretariat Division","Product Department",
                "Marketing Division","Finance Division",
                "Accounting Division","Risk Management Division","Securities Service Division",
                "Internal Control Division","Dealing Division","Advisory Division","Research Division",
                "Legal Affairs Division","IT Division","People & Workplace Division",
                "Brokerage Division","Covered Warrant Division", "Internal Audit Division"
              ] %}
                <option value="{{d}}" {% if form_data and form_data.division == d %}selected{% endif %}>{{d}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Department/Function</label>
            <select name="department" class="form-select" required>
              <option value="">-- Select Department --</option>
              {% for dep in [
                "No department","Customer Care Department","Business Analysis(Function)","Workplace(Receptionist)","Consultant(Function)","Brokerage Management Department",
                "Account Management Department","Institutional Business Department","Margin & Settlement(Financial Product)","Margin & Settlement (Operation)",
                "Network Management Department","Software Department","System Department", "Data Engineer(Function)",
                "Talent Acquisition Department","Total Rewards Department","Workplace(Purchasing)", "Workplace(General)", 
                "Learning & Development Department","Employee Engagement & Employer Branding Department",
                "Settlement & Margin Department","Depository Trading Department","Business Support Department"
              ] %}
                <option value="{{dep}}" {% if form_data and form_data.department == dep %}selected{% endif %}>{{dep}}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- === Core Competencies === -->
        <h5 class="section-header mt-4 mb-3">Core Competencies (Actual)</h5>
        <div class="row g-3">
          {% for f in ["communication","continuous_learning","critical_thinking","data_analysis","digital_literacy","problem_solving","strategic_thinking","talent_management","teamwork_leadership"] %}
          <div class="col-md-4 {% if 'strategic' in f or 'talent' in f or 'teamwork' in f %}strategic-field{% endif %}">
            <label>{{ f.replace("_"," ")|title }}</label>
            <input type="number" name="{{f}}" class="form-control" min="1" max="5" step="any"
                   value="{{ form_data[f] if form_data and form_data.get(f) else '' }}">
          </div>
          {% endfor %}
        </div>

        <!-- === Required Core Competencies === -->
        <h5 class="section-header mt-4 mb-3">Core Competencies (Required)</h5>
        <div class="row g-3">
          {% for f in ["communication_req","continuous_learning_req","critical_thinking_req","data_analysis_req","digital_literacy_req","problem_solving_req","strategic_thinking_req","talent_management_req","teamwork_leadership_req"] %}
          <div class="col-md-4 {% if 'strategic' in f or 'talent' in f or 'teamwork' in f %}strategic-field{% endif %}">
            <label>{{ f.replace("_req"," Requirement").replace("_"," ")|title }}</label>
            <input type="number" name="{{f}}" class="form-control" min="1" max="5" step="any"
                   value="{{ form_data[f] if form_data and form_data.get(f) else '' }}">
          </div>
          {% endfor %}
        </div>

        <!-- === New Competencies === -->
        <h5 class="section-header mt-4 mb-3">New Competencies (Actual)</h5>
        <div class="row g-3">
          {% for f in ["creative_thinking","resilience","ai_bigdata","analytical_thinking"] %}
          <div class="col-md-4">
            <label>{{ f.replace("_"," ")|title }}</label>
            <input type="number" name="{{f}}" class="form-control" min="1" max="5" step="any"
                   value="{{ form_data[f] if form_data and form_data.get(f) else '' }}">
          </div>
          {% endfor %}
        </div>

        <h5 class="section-header mt-4 mb-3">New Competencies (Required)</h5>
        <div class="row g-3 mb-3">
          {% for f in ["creative_thinking_req","resilience_req","ai_bigdata_req","analytical_thinking_req"] %}
          <div class="col-md-4">
            <label>{{ f.replace("_req"," Requirement").replace("_"," ")|title }}</label>
            <input type="number" name="{{f}}" class="form-control" min="1" max="5" step="any"
                   value="{{ form_data[f] if form_data and form_data.get(f) else '' }}">
          </div>
          {% endfor %}
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-3">
          <i class="bi bi-save"></i> Submit Employee Data
        </button>
      </form>
    </div>

    <footer class="mt-4 text-center text-muted small">© 2025 Employee Competency System</footer>
  </div>

  <!-- === Scripts === -->
  <script>
    const titleSelect = document.getElementById("titleSelect");
    const strategicFields = document.querySelectorAll(".strategic-field input");
    const coreFields = [
      "communication","continuous_learning","critical_thinking",
      "data_analysis","digital_literacy","problem_solving",
      "strategic_thinking","talent_management","teamwork_leadership",
      "communication_req","continuous_learning_req","critical_thinking_req",
      "data_analysis_req","digital_literacy_req","problem_solving_req",
      "strategic_thinking_req","talent_management_req","teamwork_leadership_req"
    ];

    function toggleStrategicFields() {
      const val = titleSelect.value;
      strategicFields.forEach(input => {
        if (val === "Officer" || val === "Senior") {
          input.value = "";
          input.setAttribute("readonly", true);
        } else {
          input.removeAttribute("readonly");
        }
      });
    }

    titleSelect.addEventListener("change", toggleStrategicFields);
    toggleStrategicFields();

    function validateForm() {
      const form = document.getElementById("employeeForm");
      const requiredFields = form.querySelectorAll("[required]");
      for (const field of requiredFields) {
        if (!field.value.trim()) {
          alert("Please fill all required fields!");
          field.focus();
          return false;
        }
      }
      const inputs = form.querySelectorAll("input[type=number]");
      for (const input of inputs) {
        if (input.hasAttribute("readonly")) continue;
        const name = input.name;
        const raw = input.value.trim();

        // Core competencies must NOT be empty
        if (coreFields.includes(name) && raw === "") {
          alert("Core competencies (actual & required) must not be empty and must be between 1.0–5.0.");
          input.focus();
          return false;
        }

        // New competencies are allowed to be empty
        if (raw === "") continue;

        const v = parseFloat(raw);
        if (isNaN(v) || v < 1.0 || v > 5.0) {
          alert("Competency scores must be between 1.0–5.0.");
          input.focus();
          return false;
        }
      }
      return true;
    }

    // Giữ dữ liệu khi user bấm View Employee List
    function saveFormData() {
      const form = document.getElementById("employeeForm");
      const data = new FormData(form);
      fetch("/save-form", { method: "POST", body: data });
    }

    // Tự ẩn alert sau 5s
    setTimeout(() => {
      document.querySelectorAll('.alert').forEach(a => new bootstrap.Alert(a).close());
    }, 5000);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
